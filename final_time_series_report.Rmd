---
title: "The Effect of Inversion on Pittsburgh Air Pollution"
author: "Jamie Kim, Daven Lagu, Vinay Maruri, Zachary Strennen"
date: "April 21st, 2024"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(forecast)
library(vars)
```


# Executive Summary

This study investigates the effect of atmospheric inversions on air quality in Pittsburgh, specifically focusing on how said meteorological events impact pollutant levels. Utilizing years of data from both the Allegheny County Health Department and the NOAA High Resolution Rapid Refresh model, we conducted a detailed analysis on pollutants such as $SO_2$, CO, Ozone, NO, $PM_{10}$, and $PM_{2.5}$ as well as other weather variables in the Lawrenceville area. To evaluate how inversions affect these pollutants, we developed a VARX model and defined inversions as when cold air is trapped below warmer air thus affecting local wind patterns. Our findings reveal that inversions significantly increase NO and CO levels and significantly decrease Ozone and $PM_{10}$, while having no significant effect on $SO_2$ and $PM_{2.5}$. In summation, this study emphasizes the complex relationships between weather phenomena and urban pollution allowing us to offer insights on environmental health recommendations and future air quality management.

# Introduction

Since the 1800s, the city of Pittsburgh’s air quality has been heavily influenced by the consistent presence of heavy manufacturing plants in the area. While air quality is no longer in the abysmal state it once was in the early-mid 1900s, when the steel industry was thriving in Western Pennsylvania, Pittsburgh still has some of the worst air quality in the nation according to the American Lung Association1. This is in part due to emissions from heavily polluting steel mills (operated by U.S. Steel) and petrochemical factories (operated by Shell) operating to the south and east of the city. An additional factor that contributes to air pollution in Pittsburgh is the phenomena of atmospheric inversion. Pittsburgh’s geography, which contains numerous mountains, plateaus, and river valleys can easily trap industrial pollutants when an inversion occurs because of the low cloud and fog layers that form, causing smog to be breathed in by Pittsburgh’s residents. Furthermore, because inversions generally also cause wind directions to change, the normal flow of pollutants away from the Pittsburgh area to the south is re-routed to flow over the Pittsburgh area, adding to the air quality problems. 

Our project aims to study air pollution in Pittsburgh by specifically understanding the effect of inversion on air pollution. We will calculate when inversion happens in the Pittsburgh area, and using 8 years of hourly pollution and weather data measurements, we will estimate the effect of inversion on the levels of CO, NO, S02, Ozone, $PM_{10}$, and $PM_{2.5}$ in Pittsburgh using a VARX model. We will then conclude by presenting forecasts of air pollution into the future using this model. 

# Data 

Our data came from two sources. The first data set is from the Allegheny County Health Department and contains hourly sensor data from various sensors across the greater Pittsburgh area. Each row in the data set pertains to a measurement of a specific air pollutant or weather parameter. Each of these measurements have a reported time and date along with the sensor location in which the measurements were taken. The data spans from January 2016 to present through April 2024. 

The data from the Allegheny County Health Department contain a variable called is_valid which is a boolean argument indicating whether the sensor returned a logically valid measurement for the parameter being measured. All values where is_valid was false were removed from the data. It was discovered that most data for sensors in the metropolitan Pittsburgh area did not have sufficient, continuous data at each location. Thus, we will only be considering measurements from Lawrenceville as this station had the most complete readings for all of the pollutants and environmental variables in consideration. All other locations were removed from the data.

The air pollutants in consideration are $SO_2$, CO, Ozone, NO, particulate matter under 10 micrometers in size ($PM_{10}$), and particulate matter under 2.5 micrometers in size ($PM_{2.5}$). All other pollutants were removed from the data. Additionally, some of these pollutants had illogical negative measurements and such measurements were removed from the data. NO and $PM_{2.5}$ had some measurements that were clear outliers so, for those two pollutants, any value that was several standard deviations above its mean was removed.

Because we will be considering weather as external regressors in our model the data was also filtered to only include weather parameters reasonable to the study. These are inclusive of wind direction, wind speed, rainfall, peak wind gusts, relative humidity, and barometric pressure. 

After our data cleaning process, we ended up with 72,074 observations from the air pollution dataset for our analysis. 

```{r, out.width="75%", fig.align = 'center', echo=FALSE}
knitr::include_graphics("/Users/zachstrennen/Desktop/Screenshot 2024-04-21 at 9.03.10 PM.png")
```

note: BP = Barometric Pressure (millimeters of mercury), CO = Carbon Monoxide (Parts per Billion),  INT_T = Internal Temperature of Sensor (Degrees Celsius), NO = Nitric Oxide (Parts per Billion), OUT_RH = Relative Humidity Outside the Monitoring Station (Percent), OZONE = Ozone Pollution (Parts per Million), Peak Wind Gust (miles per hour), $PM_{10}$ (micrograms per cubic meter), $PM_{2.5}$ (micrograms per cubic meter), RAINFALL = rainfall at monitoring station (Inches), $SO_2$ (Parts per Billion), SONICWD = direction of wind at monitoring station (Degrees), SONICWS = wind speed measured at monitoring station (miles per hour)The second data set is from raw GRIB file outputs for the National Oceanic and Atmospheric Administration's (NOAA) High Resolution Rapid Fresh (HRRF) atmospheric model3. We took the model's measurements of temperature (in Kelvin) at various altitudes over Pittsburgh from January 2016 to April 2024 to match the time span of the air pollution data. Since the model stores measurements by exact latitude and longitude coordinates, we used an approximate location (40.4676$^\circ$ N, 79.9606$^\circ$ W) to represent where the Lawrenceville monitoring station was located and found the nearest set of coordinates to that location in the model to take temperature observations from. The dataset is composed of daily observations of temperature at the surface and the 2-m temperature to represent temperature in the atmosphere in Pittsburgh.

# Methods

### Defining an Inversion

Given our constraints as non-experts in the area of meteorology and climate science, we took a naive, cautious approach to defining an inversion. Knowing that inversions are generally detected when temperature rises from the surface into the atmosphere, instead of the normal pattern of temperatures cooling from the surface into the atmosphere, we decided that a day would be an inversion day if this happened. 

From the NOAA data, we compared the surface temperature with the 2-m temperature to decide whether an inversion took place or not on a given day. Using this method, 22.5% of days from January 2016 to April 2024 were classified as inversion days. This differs notably from expert estimates of inversion from Allegheny County, however we chose to use our estimates for this project since the County’s estimates do not extend past 20174.

### Exploratory Data Analysis

To measure Pittsburgh air quality in the Lawrenceville area, we examined the pollutant parameters $SO_2$, CO, Ozone, NO, $PM_{10}$, and $PM_{2.5}$ from January 2016 to April 2024, filtering by the criteria mentioned in the Data Cleaning section. The time series, time series decomposition, and ACF/PACF plots were generated for all 6 pollutants to look for factors like seasonality or trend that could potentially be important when fitting a model to the data. The plots for all pollutants are shown below:
```{r, echo=FALSE, include=FALSE}
data <- read_csv("Data/cleaned_pollution_data.csv")
pittsburgh_pollution_data <- read_csv("Data/cleaned_pollution_data.csv")
```

```{r, echo=FALSE, include=FALSE}
so2_data <- data %>% filter(parameter == "SO2")
so2_data <- so2_data[, c("datetime_est", "site", "report_value")]

co_data <- data %>% filter(parameter == "CO")
co_data <- co_data[, c("datetime_est", "site", "report_value")]

ozone_data <- data %>% filter(parameter == "OZONE")
ozone_data <- ozone_data[, c("datetime_est", "site", "report_value")]

no_data <- data %>% filter(parameter == "NO")
no_data <- no_data[, c("datetime_est", "site", "report_value")]

no2_data <- data %>% filter(parameter == "NO2")
no2_data <- no2_data[, c("datetime_est", "site", "report_value")]

pm10b_data <- data %>% filter(parameter == "PM10B")
pm10b_data <- pm10b_data[, c("datetime_est", "site", "report_value")]

pm25b_data <- data %>% filter(parameter == "PM25B")
pm25b_data <- pm25b_data[, c("datetime_est", "site", "report_value")]

pm25t_data <- data %>% filter(parameter == "PM25T")
pm25t_data <- pm25t_data[, c("datetime_est", "site", "report_value")]
```
```{r, echo=FALSE, include=FALSE}
#decompose the time series data
lawrenceville_so2_data_ts <- ts(filter(so2_data, site == "Lawrenceville")$report_value, frequency = 24*365)
so2_data_decomp <- decompose(lawrenceville_so2_data_ts)

lawrenceville_co_data_ts <- ts(filter(co_data, site == "Lawrenceville")$report_value, frequency = 24*365)
co_data_decomp <- decompose(lawrenceville_co_data_ts)

lawrenceville_ozone_data_ts <- ts(filter(ozone_data, site == "Lawrenceville")$report_value, frequency = 24*365)
ozone_data_decomp <- decompose(lawrenceville_ozone_data_ts)

lawrenceville_no_data_ts <- ts(filter(no_data, site == "Lawrenceville")$report_value, frequency = 24*365)
no_data_decomp <- decompose(lawrenceville_no_data_ts)

lawrenceville_no2_data_ts <- ts(filter(no2_data, site == "Lawrenceville")$report_value, frequency = 24*365)
# no2_data_decomp <- decompose(lawrenceville_no2_data_ts)

lawrenceville_pm10b_data_ts <- ts(filter(pm10b_data, site == "Lawrenceville")$report_value, frequency = 24*365)
pm10b_data_decomp <- decompose(lawrenceville_pm10b_data_ts)

lawrenceville_pm25b_data_ts <- ts(filter(pm25b_data, site == "Lawrenceville")$report_value, frequency = 24*365)
pm25b_data_decomp <- decompose(lawrenceville_pm25b_data_ts)

lawrenceville_pm25t_data_ts <- ts(filter(pm25t_data, site == "Lawrenceville")$report_value, frequency = 24*365)
# pm25t_data_decomp <- decompose(lawrenceville_pm25t_data_ts)
```



SO2:

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
ggplot(so2_data, aes(x = datetime_est, y = report_value)) + 
  geom_line() + 
  labs(title= "$SO_2$ Time Series Plot", x = "Time", y = "Reported $SO_2$ value (PPM)") +
  theme_bw()
```

From this plot, we see a clear repeating deterministic pattern over all the years, in increments of approximately one year, where levels of the pollutant increase to a peak from the start of the year and slowly decrease again towards the end of the year, for all years in our 2016 to 2024 range, which suggests a seasonal component to our data set. This seasonal pattern becomes even more apparent when we use the decompose() function to plot the decomposition of the time series for all of our pollutants, as we did with $SO_2$ below:
 
```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
plot(so2_data_decomp)
```

Here, we see a seasonal pattern in our pollutant data for $SO_2$ exists, as well as a trend component that rises and falls over the 2016-2024 range of time we use to examine $SO_2$. These findings show that when building a model with our pollutant data, we must be able to account for the seasonal and trend component that exists in the data. Finally, we check for autocorrelation in our pollutant data by examining the ACF and PACF plots for $SO_2$, as shown below:

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
acf_so2 <- acf(so2_data$report_value, lag.max = 50, plot = FALSE)
pacf_so2 <- pacf(so2_data$report_value, lag.max = 50, plot = FALSE)
par(mfrow=c(1,2))
plot(acf_so2, main = "ACF Plot for $SO_2$")
plot(pacf_so2, main = "PACF Plot for $SO_2$")
```

Here, we see that in the ACF plot we find significant spikes for all lags and for many lags in the PACF plot (up to the maximum lag value of 50 that was specified), which gives clear evidence that we can reject the white noise hypothesis as both the ACF and PACF show significant autocorrelations over various lags. The significant autocorrelation that exists for multiple lags in both plots provides more evidence that a strong trend and/or seasonality exists in the data that must be accounted for when building our model. 

While the above plot analysis was done only for the $SO_2$ pollutant, we can see that the same behavior holds true for all pollutants, as shown below: 

CO: 

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
ggplot(co_data, aes(x = datetime_est, y = report_value)) +
  geom_line() + 
  labs(title= "CO Time Series Plot", x = "Time", y = "Reported CO value (PPB)") +
  theme_bw()
```


The plot of CO levels from 2016 to 2024 portrays a seasonal cycle, with yearly peaks suggesting an increase in carbon monoxide emissions during colder months. These regular fluctuations point towards a strong seasonal among CO levels. Additionally, the consistent yearly pattern indicates the repeatability of the trends suggesting that certain annual factors consistently influence CO emission levels.


```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
plot(co_data_decomp)
```

The decomposition of the time series for CO clarifies the nature of fluctuations. The trend component smooths out short-term variations to highlight long-term movements in CO levels, potentially reflecting the impact of environmental changes over the period. The seasonal component extracted from the time series confirms the cyclical pattern detected from the time series plot, reinforcing the presence of seasonal influences. 

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
acf_co <- acf(co_data$report_value, lag.max = 50, plot = FALSE)
pacf_co <- pacf(co_data$report_value, lag.max = 50, plot = FALSE)
par(mfrow=c(1,2))
plot(acf_co, main = "ACF Plot for CO")
plot(pacf_co, main = "PACF Plot for CO")
```

The ACF and PACF plots of CO provide additional insight to the data. The ACF plot displays a series of spikes at regular intervals, declining over time but remaining significant, confirming the seasonal effect by showing the persistent correlation between past values at seasonal lags. The PACF plot suggests that the data can be modeled by a relatively low-order autoregressive process by showing a significant spike at the first lag followed by a cut-off. This implies that even though the current CO levels are influenced by their immediate past values, the seasonal pattern is the natural part of the series structure.

Ozone: 

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
ggplot(ozone_data, aes(x = datetime_est, y = report_value)) +
  geom_line() + 
  labs(title= "Ozone Time Series Plot", x = "Time", y = "Reported Ozone value (PPM)") +
  theme_bw()
```

The time series plot of reported Ozone values indicates variable peaks throughout the period from 2016 to 2024. Unlike CO, the ozone levels do not display a clear, consistent seasonal peak; instead, they show multiple peaks within each year. This could be related to atmospheric conditions such as the inversions in Pittsburgh. Since Ozone is a pollutant formed by the reactions between other factors under sunlight, the data might reflect the complex interplay between industrial emissions and the atmospheric conditions in Pittsburgh.

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
plot(ozone_data_decomp)
```

From the Ozone decomposition plot, we observed a trend component that does not follow a simple linear path, which might indicate the impact of progressive changes in emission regulation and shifting industrial activity over time. The seasonal component exhibits complex patterns with more than one peak in a year, suggesting multiple periods when atmospheric inversions are likely to occur, leading to increased Ozone concentrations. 

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
acf_ozone <- acf(ozone_data$report_value, lag.max = 50, plot = FALSE)
pacf_ozone <- pacf(ozone_data$report_value, lag.max = 50, plot = FALSE)
par(mfrow=c(1,2))
plot(acf_ozone, main = "ACF Plot for Ozone")
plot(pacf_ozone, main = "PACF Plot for Ozone")
```

Finally, the ACF and PACF plots show the nature of the temporal relationships in the ozone data. The ACF plot’s gradual decline, with significant periodic spikes, could indicate a long-term memory process influenced by the cyclic nature of atmospheric inversions. Meanwhile the distinct initial spike in PACF plot suggests an autoregressive element possibly pointing to short-term persistence in Ozone levels.

NO: 

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
ggplot(no_data, aes(x = datetime_est, y = report_value)) +
  geom_line() + 
  labs(title= "NO Time Series Plot", x = "Time", y = "Reported NO value (PPB)") +
  theme_bw()

```

The time series plot of NO levels show a series of spikes across the eight or nine year span from 2016 to 2024. Unlike CO, these spikes appear in more erratic patterns suggesting that NO emissions in Pittsburgh may be influenced by factors other than the consistent seasonal cycles. Inversions could be contributing to these high peaks observed, especially considering NO is primarily sourced from industrial processes.

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
plot(no_data_decomp)
```

The decomposition of the NO time series reveals the individual components more clearly. The trend component shows a gradual fluctuation over time without a clear upward or downward trend, indicating that overall NO levels have not consistently increased or decreased over time. The seasonal component does not demonstrate the same clear-cut cyclical pattern, suggesting that NO levels may be influenced by more irregular seasonal factors.

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
acf_no <- acf(no_data$report_value, lag.max = 50, plot = FALSE)
pacf_no <- pacf(no_data$report_value, lag.max = 50, plot = FALSE)
par(mfrow=c(1,2))
plot(acf_no, main = "ACF Plot for NO")
plot(pacf_no, main = "PACF Plot for NO")
```

The ACF and PACF plots for NO show a complex correlation structure. The ACF plot shows a slow decay of correlation, which indicates the long-term effect of past values on future values. This could reflect the effects of inversions on NO levels. The PACF shows a significant spike at the first lag and slowly decays, indicating that the autoregressive structure is not as well pronounced as it might be expected. 

$PM_{10}$: 

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
ggplot(pm10b_data, aes(x = datetime_est, y = report_value)) +
  geom_line() + 
  labs(title= "PM10B Time Series Plot", x = "Time", y = "Reported PM10B value (UG/M^3)") +
  theme_bw()
```

The time series plot depicting $PM_{10}$ shows a high variability in dynamic air quality in Pittsburgh. The report values fluctuate considerably between peaks. The lack of a consistent seasonal pattern may indicate that these inversion events and their impact on $PM_{10}$ levels do not occur with regular seasonality but are instead influenced by a combination of factors such as weather conditions. It also exhibits a particularly noticeable cluster of high peaks towards the latter part of the timeline.

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
plot(pm10b_data_decomp)
```

Decomposing this time series, we see the trend, seasonality, and random components that provide a more detailed view of the data. The trend line shows some fluctuations but doesn’t have a clear direction of increase or decrease over time, suggesting that long-term changes in $PM_{10}$ levels are not pronounced. The seasonal component is not as regular as expected.

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
acf_pm10b <- acf(pm10b_data$report_value, lag.max = 50, plot = FALSE)
pacf_pm10b <- pacf(pm10b_data$report_value, lag.max = 50, plot = FALSE)
par(mfrow=c(1,2))
plot(acf_pm10b, main = "ACF Plot for PM10")
plot(pacf_pm10b, main = "PACF Plot for PM10")
```

The ACF plot for $PM_{10}$ demonstrates a gradual decrease in correlation over time with a series of significant spikes. This demonstrates a cyclic behavior of the data. The PACF plot, however, shows a significant correlation at first but quickly decreases, suggesting that PM10B levels are dependent on past values but don’t represent a strong autoregressive behavior. 

$PM_{2.5}$: 

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
ggplot(pm25b_data, aes(x = datetime_est, y = report_value)) +
  geom_line() + 
  labs(title= "$PM_{2.5}$ Time Series Plot", x = "Time", y = "Reported $PM_{2.5}$ value (UG/M^3)") +
  theme_bw()
```

The time series plot of $PM_{2.5}$ from 2016 to 2024 shows a noticeable pattern of fluctuations in reported values. The data shows the peaks throughout the years, which could be indicative of pollution events or changes in atmospheric conditions. 

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
plot(pm25b_data_decomp)
```

In the decomposition of $PM_{2.5}$ time series, the observed component clearly shows these spikes in pollution levels. The trend component suggests there is some variation over time, though it does not display a strong directional movement. The seasonal pattern is not as pronounced as one might expect to see with other pollutants which could be due to the complex dynamics of the pollutants. Moreover, the random component captures irregularities.

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
acf_pm25b <- acf(pm25b_data$report_value, lag.max = 50, plot = FALSE)
pacf_pm25b <- pacf(pm25b_data$report_value, lag.max = 50, plot = FALSE)
par(mfrow=c(1,2))
plot(acf_pm25b, main = "ACF Plot for $PM_{2.5}$")
plot(pacf_pm25b, main = "PACF Plot for $PM_{2.5}$")
```

The ACF plot for PM25 demonstrates a slowly decreasing correlation as lag increases which suggests that past values have some level of influence on future values even though this influence decays over time. The PACF plot shows an immediate drop after the first lag, implying that $PM_{2.5}$ concentrations are more influenced by the recent values rather than by past values. This gives us some insight in modeling as it indicates the short-term conditions. 

Taken together, we see strong evidence that, for all pollutants, there exists a trend and seasonality component that needs to be accounted for when selecting a model to accurately represent the relationships present in our pollutant data. This requires a modeling method that can show the complex relationships between multiple time series while capturing the dynamic changes of our hourly data pollutant data for all time in our 2016-2024 time range. Additionally, the modeling method we employ should be able to account for how the pollutant variables may be strongly related to each other, as the presence of all of these pollutants are strongly tied to the pollution caused by certain industrial sites in Pittsburgh. Finally, whatever model we select should be able to capture the effect of an outside factor such as inversion occurrence on the behavior of our multiple time series, even though inversion is not part of the system itself. A model that captures dynamic behavior of multiple interrelated pollutant time series, while still accounting for exogenous variables such as inversion occurrence all seem like very good supporting evidence for fitting a VARX model to our data.


### Modeling approach

To estimate how inversions affect the six pollutants, we built a VARX model with a matrix of $SO_2$, CO, Ozone, NO, $PM_{10}$, and $PM_{2.5}$ as the response, and our environmental and weather variables as the response. This model is justified by our EDA, as explained in the previous section. Moreover, since each observation contains pollution measurements that are correlated with each other, it makes sense to estimate them simultaneously in the same model, just as a VARX model does. 

Our model is defined as follows:

$$ x_t = \theta_t + \tau u_t + \sum_{j=1}^{27} \Phi_j x_{t-j} + w_t $$

As mentioned earlier, $x_t$ is a matrix of the six pollutants. $\theta_t$ is a trend fit to the model that acts as a deterministic regressor. $u_t$ is a matrix of external regressors which accounts for weather metrics (wind speed, barometric pressure, etc.) and also includes our binary indicator of inversions. Finally, for model improvement, we have $x_{t-j}$ which is a matrix of lagged pollutant values and $w_t$ which is simply just a vector of white noise. We selected 27 lags as the optimal lag number for the model after running model selection using the VARselect command with our external regressors, pollutant variables, and a maximum of 100 lags to consider (see Appendix 1). This procedure returned 27 lags selected by the Schwarz information criterion, which was a simpler model than 99 lags, and also matched our intuition from EDA that pollution today would be correlated with pollution 1 day ago, but not 4 days ago. 

While such a complex model will produce several coefficient estimates for how each pollutant is affected by each pollutant, weather metric, and or the presence of an inversion, we are mainly concerned with the coefficient of for inversion for each of the six pollutants along with its significance given by a p-value. Thus, we will be able to estimate effect size of an inversion on each of the pollutants and whether it is statistically significant or not.


# Forecast Approach

Forecasting in this project was admittedly a secondary concern since our research question is primarily a regression and inference problem. However, we can generate pollution forecasts for our model using a few assumptions. First, we assume that each of our external regressor variables follows a time series process, and that each of these time series processes won’t change or drift in the future. This allows us to project out the external regressors into the future. Second, we assume that the distribution of inversion days also stays the same into the future. This means that a future day has a 22.5% probability of being an inversion day. This allows us to generate future distributions of inversion randomly using simulations and generate a range in our pollution forecasts. 



```{r, echo=FALSE, include=FALSE}
ppd_lawrenceville <- pittsburgh_pollution_data %>%
  filter(site == "Lawrenceville" & is_valid == "TRUE")

ppd_lawrenceville_SO2 <- ppd_lawrenceville %>%
  filter(parameter == "SO2") %>%
  mutate(hour = as.numeric(format(datetime_est, "%H")))

ppd_lawrenceville_SO2_2019 <- ppd_lawrenceville_SO2 %>%
  filter(year(datetime_est) == 2019)

# Convert datetime_est to Date format (removing the time component)
ppd_lawrenceville_SO2_2019 <- ppd_lawrenceville_SO2_2019 %>%
  mutate(date = as.Date(datetime_est))

# Calculate the mean report_value for each day
daily_means <- ppd_lawrenceville_SO2_2019 %>%
  group_by(date) %>%
  summarise(mean_report_value = mean(report_value))

# Calculate the median report_value for each day
daily_medians <- ppd_lawrenceville_SO2_2019 %>%
  group_by(date) %>%
  summarise(median_report_value = median(report_value))

# Calculate the abs. val mean report_value for each day
abs_daily_means <- ppd_lawrenceville_SO2_2019 %>%
  group_by(date) %>%
  summarise(abs_mean_report_value = mean(abs(report_value)))

ppd_lawrenceville_vars <- ppd_lawrenceville %>%
  filter(parameter %in% c("NO", "SO2", "CO", "PM10B", "PM25B", "OZONE", "INT_T", "OUT_T", "SONICWS", "SONICWD", "OUT_RH", "BP", "Peak Wind Gust", "RAINFALL")) %>%
  mutate(hour = as.numeric(format(datetime_est, "%H")))

ppd_lawrenceville_PM10B <- ppd_lawrenceville_vars %>% 
  filter(parameter == "PM10B") %>%
  mutate(hour = as.numeric(format(datetime_est, "%H")))
ppd_lawrenceville_PM10B$datetime_est <- as.POSIXct(ppd_lawrenceville_PM10B$datetime_est)

# Create a sequence of datetime values starting from "2016-01-01 00:00:00" and incrementing by one hour
datetime_seq <- seq(from = as.POSIXct("2016-01-01 00:00:00"), 
                    by = "1 hour", 
                    length.out = nrow(ppd_lawrenceville_PM10B))

# Create a time series object using the report_value column and the datetime sequence
PM10B_ts <- ts(ppd_lawrenceville_PM10B$report_value, start = c(2016, 1), frequency = 365.25*24)

#long to wide, only for the variables of interest (parameter and report value)--no need for anything else
ppd_lawrenceville_vars_wide <- ppd_lawrenceville_vars %>%
  spread(parameter, report_value)

#remove unnecessary columns
ppd_lawrenceville_vars_wide <- subset(ppd_lawrenceville_vars_wide, select = -c(is_valid, unit, unit_description, highest_flag, aqs_parameter_category, hour, site))


#collapse the data into a single row for each datetime_est
ppd_lawrenceville_vars_wide <- ppd_lawrenceville_vars_wide %>%
  group_by(datetime_est) %>%
  summarise_all(mean, na.rm = TRUE)

#fill na with zero
ppd_lawrenceville_vars_wide[is.na(ppd_lawrenceville_vars_wide)] <- 0

#split the data into pollutants and environmental variables
pollutants <- ppd_lawrenceville_vars_wide[, c("datetime_est", "NO", "SO2", "CO", "PM10B", "PM25B", "OZONE")]
environmentalvariables <- ppd_lawrenceville_vars_wide[, c("datetime_est", "BP", "INT_T", "OUT_RH", "OUT_T", 
                                                          "Peak Wind Gust", "RAINFALL", "SONICWD", "SONICWS")]

#add the inversion data to the environmental variables
inversion_data <- read.csv("inversionseries.csv")

#keep only unique observations, so must de-dupe the data
inversion_data <- inversion_data[, c("time", "inversion")]
inversion_data <- inversion_data[!duplicated(inversion_data), ]

#expand the series to include all dates, set NA to False
inversion_data$time <- as.POSIXct(inversion_data$time)
inversion_data <- padr::pad(inversion_data, interval = "hour")
#replace the NA values with the value of the previous non-NA value
inversion_data$inversion <- zoo::na.locf(inversion_data$inversion)

#merge the inversion data with the environmental variables
environmentalvariables <- merge(environmentalvariables, inversion_data, by.x = "datetime_est", by.y = "time", all.x = TRUE)

#merge the two datasets together, then split them back out
ppd_lawrenceville_vars_wide <- merge(pollutants, environmentalvariables, by = "datetime_est", all = TRUE)

pollutants <- ppd_lawrenceville_vars_wide[, c("NO", "SO2", "CO", "PM10B", "PM25B", "OZONE")]
environmentalvariables <- ppd_lawrenceville_vars_wide[, c("BP", "INT_T", "OUT_RH", "OUT_T", 
                                                          "Peak Wind Gust", "RAINFALL", "SONICWD", "SONICWS", "inversion")]

#set the na values to false
environmentalvariables$inversion[is.na(environmentalvariables$inversion)] <- "False"

#convert character to true boolean
environmentalvariables$inversion <- as.logical(environmentalvariables$inversion)

rm(pittsburgh_pollution_data, ppd_lawrenceville, ppd_lawrenceville_vars, ppd_lawrenceville_vars_wide, inversion_data, daily_means, daily_medians)
rm(abs_daily_means, ppd_lawrenceville_PM10B, ppd_lawrenceville_SO2, ppd_lawrenceville_SO2_2019)

rm(PM10B_ts, datetime_seq)
rm(train)

#for some reason BP is zero for half of the data, so replace with trend values
environmentalvariables$BP[environmentalvariables$BP == 0] <- mean(environmentalvariables$BP, na.rm = TRUE)

var_1 <- VAR(pollutants, p = 27, type = "trend", exogen = environmentalvariables)
```

# Results

Our VARX model estimated the effect of lagged pollutant values, weather and environmental factors, and the effect of inversion on pollution in Pittsburgh, as well as a trend factor for pollution (for full model results see Appendix 2). 

We estimate that the effect of inversion on NO pollution is 0.108 (Standard Error = 0.074, t(71909) = 1.453, p = 0.146), on $SO_2$ pollution is -0.004 (Standard Error = 0.004, t(71909) = -0.911, p = 0.363), on CO pollution is 2.308 (Standard Error = 0.770, t(71909) = 2.996, p = 0.003), on PM10B pollution is -0.132 (Standard Error = 0.047, t(71909) = -2.823, p = 0.005), on $PM_{2.5}$ pollution is -0.004 (Standard Error = 0.078, t(71909) = -0.052, p = 0.958), and on Ozone is -0.0003 (Standard Error = 0.00004, t(71909) = -7.014, p < 2.2e-16). 

This suggests that our model found that there was a significant positive effect on CO pollution from the presence of an inversion, and a significant negative effect on Ozone and PM10B pollution from the presence of an inversion. 


When plotting time series of the VARX model residuals, we see that the values are scattered somewhat randomly around a constant mean of zero. Moreover, these residuals resemble white noise. The only thing that we should be concerned about is the high occasional spikes but this could potentially be written off as a product of the large variation of data in the model.

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
res <- residuals(var_1)
ts.plot(res, main = "Residuals of the VARX Model", ylab = "Residuals", xlab = "Time")
```

The qq-plot for the model shows several points following the red zero line, we see some expected skewing on either side. This is not ideal in terms of a normality assumption but given the complexity of the model it would be surprising to see otherwise.

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
# Checking the normality of residuals
library(MASS)
qqnorm(res, main = "Q-Q Plot of Residuals")
qqline(res, col = "red")
```

If we examine the ACF and PACF plots of the residuals for the six pollutants, we see, in the ACF plots, that there are no real discerningly significant lags beyond zero. The PACF plots show some random, significant spikes but overall these are not too concerning as these account for some leftover patterns that the model did not account for.

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}

residuals <- resid(var_1)

# Names of pollutants 
pollutant_names <- colnames(residuals)

# Loop through the first few series and plot ACF 
par(mfrow=c(2, 3))
for (i in 1:6) {
    # Plot ACF
    acf(residuals[, i], main=paste("ACF of Residuals for\n", pollutant_names[i]))
}
```

```{r, echo=FALSE, out.width="75%", fig.align = 'center'}
par(mfrow=c(2, 3))
for (i in 1:6) {
    # Plot PACF
    pacf(residuals[, i], main=paste("PACF of Residuals for\n", pollutant_names[i]))
}
```

# Discussion

While we feel confident in our analysis and the results it produced, there were some fundamental limitations in this project that we must note. 

The biggest constraint to performing the analysis was a lack of available data, because though we were able to receive the hourly weather data from 2016 to 2024 for multiple weather and pollutant parameters, much of this data was flawed (due to measurement error) or incomplete (due to sensor outages) to the point that much of it could not be used. For example, many of the pollutant parameter values were missing during times when the other pollutant values were specified or certain parameters were reported as having a negative quantity of the pollutant appearing during certain time periods, which was an obvious impossibility and showed that there was a likely error in the data collection process for a section of our data. These unusable values of certain parameters meant that certain data simply had to be excluded, which limited the amount of data we had to work with and could have adversely impacted the overall power of our analysis. 

Another constraint to our analysis process was the locational limitation of our data. Allegheny County operates air quality monitoring stations throughout the county, and although there were weather and environmental conditions measured at multiple sites (Liberty, North Braddock, Lawrenceville, Parkway East, South Fayette, Avalon, USS Clairton Sodar Site), we could not use data from many of these sites because it was incomplete either in terms of the number of pollutants it tracked or it had significant time gaps where data was not collected. For example, while the Lawrenceville site that we used for our analysis contained data for all of the pollutants of interest ($SO_2$, CO, Ozone, NO, PM10, and $PM_{2.5}$), the Liberty site only contained the pollutant data for $SO_2$, and the Avalon site contained only the $SO_2$ and $PM_{2.5}$ pollutants. Ideally, we would have been able to measure the effect of inversion on pollutants at every Allegheny County air quality monitoring site in order to get a generalized conclusion about the effect of inversion on air pollution in the area, however this was not possible in this project. Thus, our conclusions about the effect of inversion on pollution at Lawrenceville may not be generalizable to the rest of Allegheny County and the Pittsburgh area. If this project were to be repeated or expanded upon in the future, we would need to collect pollution and environmental data ourselves using our own air quality and weather monitors to ensure that we have enough usable data from all sites to enhance the statistical power and quality of our analysis.

An additional limitation to our project was that we did not have a good forecasting method since we did not have an exact way to generate future predictions of our external regressors. Our method relies on the time series processes of each of our external regressors staying the same (not changing or drifting) over time in the future. That assumption is quite strong and may not be reasonable in the context of atmospheric and weather data that has significant randomness associated with it. Furthermore, it would be ideal to be able to predict when future inversions would occur, but that was not possible in our project because we did not have access to the full NOAA HRRR model, and we do not have the knowledge or resources to reconstruct it.

A final method of improvement would be reinforcing our method of inversion detection, as the approach we employed in this project was a naive approach that only used temperature in regards to altitude to detect the occurrence of a cold air pocket being trapped under a hot air layer. While this approach should be valid, there may be a better approach to the detection process, though we could not find such reference material for building such a detection model or locate a data repository that contained data to locate an inversion occurrence. Our approach does not consider cases where inversions might be caused by an environmental factor not linked to temperature, making the inversion detection process an aspect of the project that should be improved in future iterations of the project. 

Project limitations and possible methods of improvements aside, our results do indicate that our project objective of identifying and quantifying the effect that inversion events have on pollutants in the Pittsburgh-Lawrenceville area was successful. Our model suggests that there was a significant positive effect on CO pollution from the presence of an inversion, a significant negative effect on Ozone and PM10B pollution from the presence of an inversion, and no significant effect of inversion on the levels of other pollutants. These were surprising results given that our initial hypothesis (based on what we had read about air pollution and atmospheric inversion from the research literature, as well as our discussions with Prof. Kuusela) was that inversion increases air pollution.  

One possible utilization of this model and the resulting output in a real-world scenario could be using the forecast results to determine what kind of aid to provide an area with increasing pollutant quantities. For example, if our model made forecasts for all areas of Pittsburgh and found that there was a significant increase in CO and NO pollutant levels, that might necessitate providing some kind of tangible aid to the target area such as masks, carbon monoxide detectors, air filtration systems, etc. Being able to preemptively provide material support to increase the quality of life for residents of a certain area is an invaluable benefit to public health, and such a policy response from public health authorities like the Allegheny County Health Department would be a logical extension of our current work.   



# References

 - Jessica Guay, “American Lung Association report puts Pittsburgh area among worst for air quality”, CBS News, April 19, 2023, https://www.cbsnews.com/pittsburgh/news/dangerous-for-peoples-health-american-lung-association-report-puts-pittsburgh-among-worst-places-for-air-quality/
 
 - Allegheny County Health Department, “Allegheny County Air Quality”, https://catalog.data.gov/dataset/allegheny-county-air-quality

 - Benjamin, Stanley G., et al. "Diagnostic fields developed for hourly updated NOAA weather models." (2021). https://rapidrefresh.noaa.gov/Diag-vars-NOAA-TechMemo.pdf
 
 - Sadar, Anthony J., “The Art and Science of Forecasting Morning Temperature Inversions” (2018), https://www.alleghenycounty.us/files/assets/county/v/1/government/health/documents/air-quality/sadar-emplus-article-reprint.pdf

